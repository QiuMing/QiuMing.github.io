<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="xqMing"><meta name="description" content="随着SpringBoot生态社区的日益强大，贝聊服务端团队在开发部分新系统时，也逐步采用了SpringBoot框架，并且积累了一定的经验，在此和大家做个分享。"><meta name="keywords" content=""><title>Spring Boot 在贝聊的应用 · xqMing</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://yoursite.com/2018/05/29/Spring-Boot-在贝聊的应用/"><link rel="alternate" href="/atom.xml" title="xqMing"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"></head><body><div id="main"><header><a href="/." class="logo">xqMing</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Spring Boot 在贝聊的应用</h1><span class="post-time">May 29, 2018</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Contents</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Boot-的优点"><span class="toc-text">Spring Boot 的优点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Boot-在贝聊的应用情况"><span class="toc-text">Spring Boot 在贝聊的应用情况</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在-Spring-Boot-中使用-Dubbo"><span class="toc-text">在 Spring Boot 中使用 Dubbo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#和-Elastic-Job-整合"><span class="toc-text">和 Elastic-Job 整合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#和-Disconf-整合"><span class="toc-text">和 Disconf 整合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#和-Mybatis、Druid-以及多数据源整合"><span class="toc-text">和 Mybatis、Druid 以及多数据源整合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#和-Cat-监控整合"><span class="toc-text">和 Cat 监控整合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-spring-boot-start-web-log-统一拦截请求和响应日志"><span class="toc-text">使用 spring-boot-start-web-log 统一拦截请求和响应日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在已有发布系统上部署-Spring-Boot-应用"><span class="toc-text">在已有发布系统上部署 Spring Boot 应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></div><div class="post-content"><p>随着 Spring Boot 生态社区的日益强大，贝聊服务端团队在开发部分新系统时，也逐步采用了 Spring Boot 框架，并且积累了一定的经验，在此和大家做个分享。</p>
<a id="more"></a>
<h2 id="Spring-Boot-的优点"><a href="#Spring-Boot-的优点" class="headerlink" title="Spring Boot 的优点"></a>Spring Boot 的优点</h2><p>项目采用 Spring Boot ，和直接使用 Spring MVC ，有什么优点了？这里我们分析了下，大概有以下几点：</p>
<ul>
<li>使用 Java Config 的配置方式替代 xml文件 配置，实现配置类复用。避免每次构建新的 Spring MVC 建项目，都得往旧的项目中拷贝 xml 配置文件。</li>
<li>社区提供的丰富的 Starter pom 依赖包，极大方便了我们整合第三方框架。</li>
<li>提供嵌入式 Servlet 容器，支持 jar 和 war 部署，给运维和开发都带来了极大的便利。</li>
<li>自动管理依赖，勉去版本冲突烦恼。</li>
<li>提供了基本的应用监控的功能。</li>
</ul>
<p>总结来说，相比于直接使用 Spring MVC 构建项目，Spring Boot 使我们在开发、配置、监控、部署的过程中，都变得更加简单。</p>
<h2 id="Spring-Boot-在贝聊的应用情况"><a href="#Spring-Boot-在贝聊的应用情况" class="headerlink" title="Spring Boot 在贝聊的应用情况"></a>Spring Boot 在贝聊的应用情况</h2><p>在讲Spring Boot 之前，有必要讲下我们贝聊服务端现在有用到的技术栈：</p>
<ul>
<li>基础框架 Spring MVC；</li>
<li>服务治理方面，使用了 Dubbo；</li>
<li>数据库层面，使用了 Mybatis，Druid，并配置了多数据源；</li>
<li>权限控制用到 Shiro；</li>
<li>分布式配置，使用了 Disconf；</li>
<li>分布式定时任务，使用 Elastic-Job；</li>
<li>全链路监控方面使用了 Cat；</li>
<li>部署方面，我们用自己的发布系统；</li>
</ul>
<p>引入Spring Boot ，则必须要支持我们现有的技术栈，并且要能够让新同事能够很快熟悉。依托于Spring Boot 约定优于配置的理念，及官方和社区提供的各种丰富的 Starter pom 配置，在各同事的支持下，各方面的整合，都相对顺利。在接下来的文字里，我会和大家讲解贝聊在使用 Spring Boot 的一些情况。</p>
<h3 id="在-Spring-Boot-中使用-Dubbo"><a href="#在-Spring-Boot-中使用-Dubbo" class="headerlink" title="在 Spring Boot 中使用 Dubbo"></a>在 Spring Boot 中使用 Dubbo</h3><p>贝聊服务端使用了 Dubbo 框架来实现服务治理，Dubbo 目前在  Apache 孵化器进行孵化，官方也提供了 <a href="https://github.com/apache/incubator-dubbo-spring-boot-project" target="_blank" rel="external">incubator-dubbo-spring-boot-project</a>，不过官方的 0.1.0 版本在4月份才发布，在此之前，我们编写了自己的 spring-boot-starter-dubbo，并满足已有需求。</p>
<p>新项目在使用了 spring-boot-starter-dubbo 后，我们在暴露和引入 Dubbo 服务时，均使用了注解的形式，抛弃了原本的 xml  配置方式，开发的时候不用在关注是否在 dubbo.xml 中是否有引入服务，编码时相对轻松了不少。</p>
<h3 id="和-Elastic-Job-整合"><a href="#和-Elastic-Job-整合" class="headerlink" title="和 Elastic-Job 整合"></a>和 Elastic-Job 整合</h3><p>贝聊在很早的时候，就使用了 Elastic-Job 来进行分布式作业管理，且一直沿用了较低版本，没有做升级。之前已有的项目，Elastic-Job 的配置和作业都是放在一个 spring-job.xml 文件里面。在整合 Elastic-Job 和 Spring Boot 的时候，发现社区有开源的 spring-boot-starer-elastic-job，不过采用了最新版的 Elastic-Job-Lite。<br>在此背景下，我准备了两种方案：</p>
<ul>
<li>采用 <strong>@ImportResource({“classpath<em>:spring-</em>.xml”})</strong>  方式来兼容旧版本的 Elastic-Job 的任务，自己在写 demo 时运行正常；</li>
<li>升级 Elastic-Job 版本为 Elastic-Job-Lite，并安装最新版的 Elastic-Console ，参考社区的 Starter ,编写使用注解方式配置定时任务，去 xml；</li>
</ul>
<p>后面和同事讨论下，采用了后面的方案，升级  Elastic-Job 版本为 Elastic-Job-Lite，新项目使用 spring-boot-starter-elastic-job 来配置，并且使用注解来声明作业。至此，又一个 xml 文件被移除。</p>
<h3 id="和-Disconf-整合"><a href="#和-Disconf-整合" class="headerlink" title="和 Disconf 整合"></a>和 Disconf 整合</h3><p>Discof 是贝聊在早期引进的分布式配置管理工具，使用起来也很简单，虽然原作者已经停止维护，但还是有热心的网友提供了 <a href="https://github.com/xjzrc/disconf-spring-boot-starter" target="_blank" rel="external">disconf-spring-boot-starter</a> ，基于此 Starter ，也极大简化了我们在新项目中的配置成本，新入职的同事在配置 Discof 的时候，也不需要再去拷贝旧项目 Diconf 的 xml 配置。</p>
<h3 id="和-Mybatis、Druid-以及多数据源整合"><a href="#和-Mybatis、Druid-以及多数据源整合" class="headerlink" title="和 Mybatis、Druid 以及多数据源整合"></a>和 Mybatis、Druid 以及多数据源整合</h3><p>这部分整合是相对容易的，Mybatis 和 Druid 官方，均有提供自动化配置的 Starter pom，拿来来开箱即用。</p>
<p>需要特殊处理的是多数据源配置，之前系统用的公司统一的配置类，不过是 xml 配置。为了为复用代码，我们将其转为了 Java Config 的方式，并计划在未来也抽成一个自动化配置的 Starter 包。同样，我们在整合 Shiro 的时候，也是采用了Java Config的形式，并整合 JWT 作为接口访问令牌。</p>
<h3 id="和-Cat-监控整合"><a href="#和-Cat-监控整合" class="headerlink" title="和 Cat 监控整合"></a>和 Cat 监控整合</h3><p>APM 监控方面，我们公司使用了 cat，平台组的同事搭建了 cat，并且提供了对应的整合方式，其中一些配置 bean 注入的时候，还是使用 xml 的方式，后面笔者将其改为了 javaconfig 的方式，总个整合过程如下：</p>
<ul>
<li>1、引入cat 相关 jar 包；</li>
<li>2、如果是 web 项目，要注入 CatServletFilter ，实现 MVC层CAT配置；</li>
<li>3、如果是项目中用到了 dubbo ，添加 CatDubboFilter ；</li>
<li>4、在 META-INF 中添加 app.properties，声明项目名字；</li>
<li>5、在 logback-spring.xml 中添加 CatLogbackAppender 配置；</li>
</ul>
<p>上面的5个步骤中，前面3个步骤是可以合并为一个，2和3 两个步骤，可以通过将xml 配置变成Java Config 的方式，并生成一个 spring-boot-starter-cat-monitor 包，实现配置类的重用，下面也简单介绍下步骤2和3实现自动化配置的原理：</p>
<ul>
<li>注入CatServletFilter，主要是利用 <strong>@ConditionalOnWebApplication</strong> 注解，如果当前环境是web环境，则该配置类会生效，核心代码如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 功能：web 环境下，集成cat监控功能</div><div class="line"> */</div><div class="line">@Configuration</div><div class="line">@ConditionalOnWebApplication</div><div class="line">public class CatWebFilterConfigure &#123;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    public FilterRegistrationBean catFilter() &#123;</div><div class="line">        FilterRegistrationBean registration = new FilterRegistrationBean();</div><div class="line">        registration.setFilter(new CatServletFilter());</div><div class="line">        registration.addUrlPatterns(&quot;/*&quot;);</div><div class="line">        registration.setDispatcherTypes(DispatcherType.REQUEST,DispatcherType.FORWARD);</div><div class="line">        registration.setName(&quot;cat-filter&quot;);</div><div class="line">        return registration;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>注入CatDubboFilter，主要是利用Dubbo的 <strong>@Activate</strong> 来无条件激活配置。因为我们所有的项目，都整合了Dubbo，所以不需要根据环境来注入配置类。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 功能：dubbo cat 监控，使用Activate注解, 无条件自动激活,不需要在yml 配置中声明该filter 了</div><div class="line"> */</div><div class="line">@Activate(group = &#123;Constants.PROVIDER, Constants.CONSUMER&#125;)</div><div class="line">public class CatBootDubboConfigure extends Filter &#123;</div><div class="line">    //此处省略具体的埋点操作</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用-spring-boot-start-web-log-统一拦截请求和响应日志"><a href="#使用-spring-boot-start-web-log-统一拦截请求和响应日志" class="headerlink" title="使用 spring-boot-start-web-log 统一拦截请求和响应日志"></a>使用 spring-boot-start-web-log 统一拦截请求和响应日志</h3><p>上面说了好些 starter ，都是用了社区已有的轮子，当然，我们团部内部，也有封装一些简单的 Starter ，以实现代码复用，简化配置。</p>
<p>我们在日常接口开发的调试阶段，经常需要查看接口请求和响应日志。使用 Spring 来拦截接口请求和响应日志，有多种实现方式，可以自己定义 Filter，Intercepter，或者使用 Aspectj，如果每一个 Web 项目，都来写一套实现，或者从别的项目中拷贝一份，这肯定不是一个好的方式。基于此情况，践行 Spring Boot 约定优于配置的原则，我们自己内部封装了 spring-boot-start-web-log，并提供了一些常见的配置项。新的 Web 项目需要时，只需要引入依赖，并在 yml 配置文件中加入如下配置就好：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">web.log:</div><div class="line">    ## 拦截路径</div><div class="line">    mapping-path: &quot;/*&quot;</div><div class="line">    ## 排除路径</div><div class="line">    exclude-mapping-path: &quot;/files/*;/favicon.ico;/login;/captcha/*</div><div class="line">    ## 打印header,多个按照&apos;;&apos;分隔</div><div class="line">    print-header: &quot;Authorization&quot;</div><div class="line">    ## 是否允许打印日志，默认true,建议生成关闭</div><div class="line">    enable: true</div></pre></td></tr></table></figure>
<h3 id="在已有发布系统上部署-Spring-Boot-应用"><a href="#在已有发布系统上部署-Spring-Boot-应用" class="headerlink" title="在已有发布系统上部署 Spring Boot 应用"></a>在已有发布系统上部署 Spring Boot 应用</h3><p>刚开始在我们已有的发布系统上部署 Spring Boot 应用时，遇到了一些问题。</p>
<p>在部署应用方面，我们尝试了 war 包部署和 jar 部署两种方式。其中采用 war 包部署时，发现会和现有的 Resin 有冲突，需要移除 Resion 的部分 jar ，比较麻烦，所以我们采用 jar 包部署的方式。</p>
<p>使用 jar 包部署，我们也遇到了一些问题。我们已有的 Dubbo 应用部署，就是采用了 jar 包部署。去除一些 JWVM 参数是可配置的，最终都是使用到 <strong>java -cp  jar包路径  类名</strong>  的命令来运行应用。注意，这种方式，是需要指定jar路径和类名的，和 <strong>java -jar spring-boot-app.jar</strong>是不一样的，因此，为了避免脚本改动，我们得适配现有的发布脚本。</p>
<p>Dubbo 打成可独立运行的 jar  包，使用了 <strong>maven-shade-plugin</strong> 插件，指定的类名是 <strong>com.alibaba.dubbo.container.Main</strong> 。而在打包 Spring Boot 应用时，我们采用了 <strong>spring-boot-maven-plugin</strong>插件 。在选择<strong>java -cp</strong> 命令所需要参数类名时，我们刚开始使用了Spring Boot默认的 Application 启动类，毕竟我们开发的时候，也是直接运行该类的 main 方法来启动应用。然而实际运行的时候，发现应用根本起不来，提示找不到或无法加载主类。后面经过一番资料查找与学习，才解决了该问题。</p>
<p>解决问题的关键，在于要了解 jar 运行的原理，也就是MANIFEST.MF文件。<br>解压Spring Boot 打包后的jar文件，其中MANIFEST.MF文件如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Manifest-Version: 1.0</div><div class="line">Implementation-Title: demo</div><div class="line">Implementation-Version: 0.0.1-SNAPSHOT</div><div class="line">Archiver-Version: Plexus Archiver</div><div class="line">Built-By: Ming</div><div class="line">Implementation-Vendor-Id: com.beiliao.app</div><div class="line">Spring-Boot-Version: 1.5.4.RELEASE</div><div class="line">Implementation-Vendor: Pivotal Software, Inc.</div><div class="line">Main-Class: org.springframework.boot.loader.JarLauncher</div><div class="line">Start-Class: com.beiliao.app.DemoApplication</div><div class="line">Spring-Boot-Classes: BOOT-INF/classes/</div><div class="line">Spring-Boot-Lib: BOOT-INF/lib/</div><div class="line">Created-By: Apache Maven 3.3.1</div><div class="line">Build-Jdk: 1.8.0_73</div><div class="line">Implementation-URL: http://projects.spring.io/spring-boot/demo/</div></pre></td></tr></table></figure></p>
<p>注意到这里面 <strong>Main-Class: org.springframework.boot.loader.JarLauncher</strong> 才是主方法，使用<strong>java -jar spring-boot-app.jar</strong> 可以运行Spring Boot 应用，是因为  <strong>spring-boot-maven-plugin</strong> 插件在打包的时候已经生成该文件 ，<strong>java -jar </strong> 命令会读取到该文件 。因此，在启动Spring Boot 应用时，真正的启动命令应该是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">windows:</div><div class="line">java -cp .;c:\\Project\\boot-demo\\target\\demo-0.0.1-SNAPSHOT.jar  org.springframework.boot.loader.JarLauncher</div><div class="line">linux:</div><div class="line">java -cp .:/data/project/demo/*  org.springframework.boot.loader.JarLauncher</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是Spring Boot 在贝聊的一些应用情况。目前贝聊已经有几个新项目使用到 Spring Boot ，并在组内反响不错，用过的开发同事多说比之前直接用 Spring MVC 要方便不少。公司 gitlab 仓库的 starter 依赖包也有6个了，未来还会增加。 </p>
</div></article><div class="tags"></div><div class="paginator"><a href="/2018/05/29/在Spring中实现组合请求接口/" class="prev"><i class="iconfont icon-left"></i><span> Prev</span></a><a href="/2016/10/13/Linux-Minit-18-折腾记/" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div data-thread-key="http://yoursite.com/2018/05/29/Spring-Boot-在贝聊的应用/index.html" data-title="Spring Boot 在贝聊的应用" data-url="http://yoursite.com/2018/05/29/Spring-Boot-在贝聊的应用/index.html" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name: "xqming" };
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></section></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2018<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">xqMing</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>