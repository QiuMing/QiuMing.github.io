<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="xqMing"><meta name="description" content="Spring组合请求APIdemo背景app在启动的时候，会调用服务端多个接口，随着业务迭代开发，请求接口会越来越多，致使app在启动的时候会有多次io请求，启动缓慢。为解决此问题，app端同学会要求服务端同学，在一个接口内，返回多种业务数据，或者要求在一个"><meta name="keywords" content=""><title>Spring Boot 实现组合接口 · xqMing</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://yoursite.com/2018/05/29/Spring-Boot-实现组合接口/"><link rel="alternate" href="/atom.xml" title="xqMing"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"></head><body><div id="main"><header><a href="/." class="logo">xqMing</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Spring Boot 实现组合接口</h1><span class="post-time">May 29, 2018</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Contents</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-组合请求-API-demo"><span class="toc-text">Spring 组合请求 API demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#背景"><span class="toc-text">背景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分析"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现"><span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#不带注解事例"><span class="toc-text">不带注解事例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#带-RequestParam-注解例子"><span class="toc-text">带 @RequestParam 注解例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#带-PathVariable-注解例子"><span class="toc-text">带 @PathVariable 注解例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TODO"><span class="toc-text">TODO</span></a></li></ol></div><div class="post-content"><h2 id="Spring-组合请求-API-demo"><a href="#Spring-组合请求-API-demo" class="headerlink" title="Spring 组合请求 API demo"></a>Spring 组合请求 API demo</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><ul>
<li>app 在启动的时候，会调用服务端多个接口，随着业务迭代开发，请求接口会越来越多，致使 app 在启动的时候会有多次 io 请求，启动缓慢。</li>
<li>为解决此问题，app 端同学会要求服务端同学，在一个接口内，返回多种业务数据，或者要求在一个接口，组合响应多个接口数据。在此背景下，组合请求接口因需而生。</li>
</ul>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ul>
<li>服务端定义的 restful 接口，合理划分好粒度，标明哪些是支持组合请求接口的。</li>
<li>客户端同学，按需要，自己组合请求所需要的接口（前提是这些接口支持放在组合接口内），带上参数，一次性请求到服务端，服务端一次处理好多个接口请求后，统一返回多个接口数据。</li>
</ul>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><ul>
<li>通过 requestMappingHandlerMapping.getHandlerMethods() 方法，可以获取到所有的方法处理器，即为 <figure class="highlight plain"><figcaption><span>HandlerMethod> HandlerMethodMap = requestMappingHandlerMapping.getHandlerMethods();```</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">* 根据 requestItem 中的 url 和 method ，遍历 HandlerMethodMap ，可以唯一确定一个 HandlerMethod。</div><div class="line">* 获取到 HandlerMethod ，后面可以从里面取到该方法所在类，利用 ReflectionUtils.invokeMethod(method, object, args) 反射执行方法，获取结果。</div><div class="line"></div><div class="line">## 举例说明：</div><div class="line"></div><div class="line">* 为了安全控制，在支持组合接口的方法上面，要加上 ``` @EnableCombineRequest ``` 注解。告诉 Spring 容器，这方法支持放在组合接口中，如果把不支持组合接口放到组合接口中去请求，会报``` IllegalArgumentException</div></pre></td></tr></table></figure></li>
</ul>
<h3 id="不带注解事例"><a href="#不带注解事例" class="headerlink" title="不带注解事例"></a>不带注解事例</h3><ul>
<li><p>请求的 request</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[&#123;<span class="attr">"method"</span>:<span class="string">"GET"</span>,<span class="attr">"requestId"</span>:<span class="string">"111"</span>,<span class="attr">"url"</span>:<span class="string">"/ming"</span>&#125;,&#123;<span class="attr">"method"</span>:<span class="string">"GET"</span>,<span class="attr">"requestId"</span>:<span class="string">"222"</span>,<span class="attr">"url"</span>:<span class="string">"/fang"</span>&#125;]</div></pre></td></tr></table></figure>
</li>
<li><p>响应的 response</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[&#123;<span class="attr">"requestId"</span>:<span class="string">"222"</span>,<span class="attr">"url"</span>:<span class="string">"/fang"</span>,<span class="attr">"httpStatus"</span>:<span class="number">200</span>,<span class="attr">"entity"</span>:&#123;<span class="attr">"id"</span>:<span class="number">1</span>,<span class="attr">"name"</span>:<span class="string">"芳"</span>&#125;&#125;,&#123;<span class="attr">"requestId"</span>:<span class="string">"111"</span>,<span class="attr">"url"</span>:<span class="string">"/ming"</span>,<span class="attr">"httpStatus"</span>:<span class="number">200</span>,<span class="attr">"entity"</span>:&#123;<span class="attr">"id"</span>:<span class="number">2</span>,<span class="attr">"name"</span>:<span class="string">"明"</span>&#125;&#125;]</div></pre></td></tr></table></figure>
<h3 id="带-RequestParam-注解例子"><a href="#带-RequestParam-注解例子" class="headerlink" title="带 @RequestParam 注解例子"></a>带 @RequestParam 注解例子</h3><ul>
<li>处理方法</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@EnableCombineRequest</span></div><div class="line"><span class="variable">@GetMapping</span>(path = <span class="string">"/liang"</span>)</div><div class="line">public UserDto getLiang(<span class="variable">@RequestParam</span>(name=<span class="string">"userName"</span>,defaultValue = <span class="string">"明"</span>)String  name,Integer id) &#123;</div><div class="line">    <span class="selector-tag">log</span><span class="selector-class">.info</span>(<span class="string">"name:&#123;&#125;,age:&#123;&#125;"</span>,name,id);</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-tag">new</span> <span class="selector-tag">UserDto</span>(id,name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>请求的 request</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[&#123;<span class="attr">"method"</span>:<span class="string">"GET"</span>,<span class="attr">"requestId"</span>:<span class="string">"1111"</span>,<span class="attr">"param"</span>:&#123;<span class="attr">"id"</span>:<span class="number">11</span>&#125;,<span class="attr">"url"</span>:<span class="string">"/liang"</span>&#125;,&#123;<span class="attr">"method"</span>:<span class="string">"GET"</span>,<span class="attr">"requestId"</span>:<span class="string">"222"</span>,<span class="attr">"param"</span>:&#123;<span class="attr">"param"</span>:<span class="string">"亮"</span>,<span class="attr">"id"</span>:<span class="number">12</span>&#125;,<span class="attr">"url"</span>:<span class="string">"/liang"</span>&#125;]</div></pre></td></tr></table></figure>
<ul>
<li>响应的 response</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[&#123;<span class="attr">"requestId"</span>:<span class="string">"1111"</span>,<span class="attr">"url"</span>:<span class="string">"/liang"</span>,<span class="attr">"httpStatus"</span>:<span class="number">200</span>,<span class="attr">"entity"</span>:&#123;<span class="attr">"id"</span>:<span class="number">11</span>,<span class="attr">"name"</span>:<span class="string">"明"</span>&#125;&#125;,&#123;<span class="attr">"requestId"</span>:<span class="string">"222"</span>,<span class="attr">"url"</span>:<span class="string">"/liang"</span>,<span class="attr">"httpStatus"</span>:<span class="number">200</span>,<span class="attr">"entity"</span>:&#123;<span class="attr">"id"</span>:<span class="number">12</span>,<span class="attr">"name"</span>:<span class="string">"亮"</span>&#125;&#125;]</div></pre></td></tr></table></figure>
<h3 id="带-PathVariable-注解例子"><a href="#带-PathVariable-注解例子" class="headerlink" title="带 @PathVariable 注解例子"></a>带 @PathVariable 注解例子</h3><ul>
<li><p>处理方法</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@EnableCombineRequest</span></div><div class="line"><span class="variable">@GetMapping</span>(path = <span class="string">"/qiu/&#123;id&#125;"</span>)</div><div class="line">public UserDto getQiu(<span class="variable">@PathVariable</span>(name=<span class="string">"id"</span>)Integer id,<span class="variable">@RequestParam</span>(name=<span class="string">"userName"</span>,defaultValue = <span class="string">"丘"</span>)String  name) &#123;</div><div class="line">    <span class="selector-tag">log</span><span class="selector-class">.info</span>(<span class="string">"name:&#123;&#125;,age:&#123;&#125;"</span>,name,id);</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-tag">new</span> <span class="selector-tag">UserDto</span>(id,name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>请求例子 </p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[&#123;<span class="attr">"method"</span>:<span class="string">"GET"</span>,<span class="attr">"requestId"</span>:<span class="string">"111"</span>,<span class="attr">"url"</span>:<span class="string">"/qiu/11"</span>&#125;,&#123;<span class="attr">"method"</span>:<span class="string">"GET"</span>,<span class="attr">"requestId"</span>:<span class="string">"222"</span>,<span class="attr">"param"</span>:&#123;<span class="attr">"userName"</span>:<span class="string">"秋"</span>&#125;,<span class="attr">"url"</span>:<span class="string">"/qiu/22"</span>&#125;]</div></pre></td></tr></table></figure>
<ul>
<li>响应例子<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[&#123;<span class="attr">"requestId"</span>:<span class="string">"111"</span>,<span class="attr">"url"</span>:<span class="string">"/qiu/11"</span>,<span class="attr">"httpStatus"</span>:<span class="number">200</span>,<span class="attr">"entity"</span>:&#123;<span class="attr">"id"</span>:<span class="number">11</span>,<span class="attr">"name"</span>:<span class="string">"丘"</span>&#125;&#125;,&#123;<span class="attr">"requestId"</span>:<span class="string">"222"</span>,<span class="attr">"url"</span>:<span class="string">"/qiu/22"</span>,<span class="attr">"httpStatus"</span>:<span class="number">200</span>,<span class="attr">"entity"</span>:&#123;<span class="attr">"id"</span>:<span class="number">22</span>,<span class="attr">"name"</span>:<span class="string">"秋"</span>&#125;&#125;]</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>细节重构，详细说明不支持的情况</p>
</div></article><div class="tags"></div><div class="paginator"><a href="/2018/05/29/Spring-Boot-在贝聊的应用/" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div data-thread-key="http://yoursite.com/2018/05/29/Spring-Boot-实现组合接口/index.html" data-title="Spring Boot 实现组合接口" data-url="http://yoursite.com/2018/05/29/Spring-Boot-实现组合接口/index.html" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name: "xqming" };
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></section></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2018<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">xqMing</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>